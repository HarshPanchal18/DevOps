apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter

metadata:
  name: production-rate-limit
  namespace: production

spec:
  workloadSelector: # The selector to identify the workloads to which the filter is applied.
    labels:
      app: production

  configPatches:
    - applyTo: HTTP_FILTER # The type of the patch.
      match:
        context: SIDECAR_INBOUND # The context in which the filter is applied. In this case, it's applied to inbound traffic to the sidecar proxy.
        listener: # The listener to which the filter is applied. In this case, it's applied to the listener for HTTP traffic.
          portNumber: 5000 # The port number of the listener.
          filterChain: # The filter chain to which the filter is applied.
            filter: # The filter to which the patch is applied.
              name: envoy.filters.network.http_connection_manager

      patch:
        operation: INSERT_BEFORE # The operation to perform. In this case, it's inserting the filter before the specified filter.

        value:
          name: envoy.filters.http.local_ratelimit # The name of the filter to be inserted.

          typed_config: # The configuration for the filter.
            "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            stat_prefix: http_local_rate_limiter

            token_bucket: # Five requests per second
              max_tokens: 5 # The maximum number of tokens in the bucket
              tokens_per_fill: 5 # The number of tokens to add to the bucket per fill
              fill_interval: 60s # The interval at which tokens are added to the bucket
              # The 6th request gets a 429 Too Many Requests.

            filter_enabled: # Filter to enable or disable the rate limit
              runtime_key: local_rate_limit_enabled # The key used to enable or disable the filter at runtime
              default_value:
                numerator: 100
                denominator: HUNDRED

            filter_enforced: # Filter to enforce the rate limit
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
